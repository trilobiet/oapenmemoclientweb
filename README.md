# Oapen MEMO Client Web

The MEMO Client Web is a web site that serves exported files, generated by MEMO Task Runner, from the client directories.
    
MEMO clients (customers) can download these files. The client web is a restricted area. 
You need a user account to access the site. Clients can only view their own data.
    

## Configuration

* `server.port`
   Choose a free port (e.g. 8083) to map your external web server (NGINX) to.
* `spring.datasource.url`
   Database url (`jdbc:mysql://12.34.56.123:3306/oapen_memo?reconnect=true&rewriteBatchedStatements=true`)
* `spring.datasource.username`
* `spring.datasource.password`
   Login credentials 
* `application.filesroot`
   Root directory for the generated export files (`${user.home}/oapenmemo/exports/`). OAPEN Task Runner writes its output here.
   See below (Files root directory) for a detailed explanation.
*  `path.customresources` 
   System path to resources for UI customization, e.g. `file:/home/oapen/oapenmemo/clientweb/customresources/`
   


### Files root directory

The directory at `application.filesroot` has a sub-directory for each client containing the files generated by the task runner.

	exports
	  |-- abc_corp
	  |-- a_client
	  |-- another_client
	  .
	  .
	  |-- tmp
	  .
	  .
	  |-- zzz_corp
	  
These directories contain the latest version of exported data for each task for the associated client, 
given the current date is after the task's `startDate` value. (`tmp` is a special directory for internal use, not associated with any client.)

Given a client 'abc_corp' and a task 'some_fancy_task' of type `xml` the associated file will be located at `exports/abc_corp/some_fancy_task.xml`.


## Custom resources

The clients website can be customized to display your logo and optionally adjust some of the colors to reflect your organization's identity.

The directory targeted in `path.customresources` must contain 3 files:

- `custom.css`   
   Override default styles for the manager application here, or leave empty;
- `logo.png`   
   The logo shown on the login screen;
- `favicon.ico`   


## Installation and running

This application must be installed as a service.

- Create an installation directory under the user's (`oapen`) home directory;
- Copy `clientweb-x.y.z.jar` to the user's (`oapen`) home directory;
- Copy `src/main/resources/application.properties.tpl` to the installation directory and rename to `application.properties`;
- Edit `application.properties` (see above 'Configuration');
- Create a directory `customresources` (see above 'Custom resources');
- Create a symlink `ln -s clientweb-x.y.z.jar clientweb.jar`;
- In `/etc/systemd/system` create a file named `oapen-memo-clientweb.service`. See
  [Readme-memowebsite-service.txt](./Readme-memowebsite-service.txt) for an example.  
- Choose a **free** internal port and create a mapping on your web server to access the application from the internet   
  (NGINX example below for 'memomanager.oapen.org', internal port 8083):
        
        server {
            
            server_name memo.oapen.org;
            
            location / {
                proxy_set_header Host $host;
                proxy_set_header x-forwarded-for $remote_addr;
                proxy_pass http://localhost:8083; # -> use the same port as in application.properties!
            }
        }
    
- Run `certbot` or use an equivalent tool to obtain an SSL Certificate and enforce secure connections.


## Usage        

After signing in, a single page is shown listing the most recent versions of all Task exports for which the `startDate` has passed. 
Click on the links to view or download the files.

As soon as the Task Manager generates a new report it will be listed here, overwriting any previous version.

When a chain icon ðŸ”— appears in the 'public link' column, the associated link is intended for public use and can be copied safely to other pages on the Internet.

![MEMO Client web](./src/main/resources/static/assets/images/MEMO-Clientweb-1.png)


## Access to resources

Application access is only available for authorized users. Users are authenticated via a login page. Accounts (username + password) can only be created and managed through the MEMO Manager application.

Resources (exported files resulting from tasks being run) however, are available without authentication, but access to them can be restricted using an access key. Access restriction on a resource can be used to allow third party applications knowing the key to request the resource, without making the resource public.

Whether access to a resource is restricted is decided in the MEMO Administrator application, where the access key can also be generated. 

> **âš  MEMO Customers should be careful not to share the access key nor publish links containing the access key.**   
> 
> The access key is defined on the client level, not the task level. Once a client's key is compromised, it will grant access to **all** exports for that client. 

In order to request an access restricted resource, the access key must be appended to the request:

    https://memo.oapen.org/file/ABC_Corp/a_private_file.json?key=4fdd4c3c0eff4aed8a029d9b9638fe77

Not access restricted resources can be requested without an access key:

	https://memo.oapen.org/file/ABC_Corp/a_public_file.json

Attempts to request an access restricted file without a key will be answered with a `401 Unauthorized` response status code.



